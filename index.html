<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Insurance Return Studio • IRR ระดับโปร</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg-from:#f8fafc; --bg-to:#eef2ff; --card:#ffffff; --line:#e5e7eb;
    --text:#0f172a; --muted:#64748b; --accent:#6366f1; --accent-2:#4f46e5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif;
    background:radial-gradient(1200px 600px at 20% -10%, #eef2ff 0%, transparent 60%),
               linear-gradient(180deg,var(--bg-from),var(--bg-to));
    color:var(--text);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.08)}
  .btn{border:1px solid var(--line);border-radius:12px;padding:.9rem 1rem;line-height:1}
  .btn-primary{background:#101113;color:#fff;border-color:#101113}
  .seg{border:1px solid var(--line);border-radius:999px;padding:.35rem;display:inline-flex;gap:.25rem;background:#fff}
  .seg button{padding:.55rem .95rem;border-radius:999px;font-weight:600}
  .seg .active{background:#0f172a;color:#fff}
  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:1rem .95rem;font-size:1rem}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{border-bottom:1px solid var(--line);padding:.75rem;text-align:right;font-size:.95rem;white-space:nowrap}
  .table th:first-child,.table td:first-child{text-align:center}
  .kpi{border:1px solid var(--line);border-radius:14px;padding:16px;background:#fff;min-width:240px}
  .kpi .val{font-size:1.9rem;font-weight:700}
  .hint{font-size:.86rem;color:var(--muted)}
  .grid1{display:grid;grid-template-columns:1fr;gap:.75rem}
  @media(min-width:640px){ .grid2-sm{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:768px){ .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem}
  }
  header.appbar{position:sticky;top:0;z-index:40;backdrop-filter:blur(8px);background:rgba(255,255,255,.7);border-bottom:1px solid var(--line)}
  nav.bottom{position:sticky;bottom:0;z-index:40;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-top:1px solid var(--line);padding:6px 8px}
  nav.bottom .tab{flex:1;border-radius:12px;padding:.75rem .4rem;text-align:center;font-size:.9rem;border:1px solid transparent}
  nav.bottom .tab.active{background:#0f172a;color:#fff}
</style>
</head>
<body>
<header class="appbar">
  <div class="wrap py-3 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="text-lg font-semibold">Insurance Return Studio</div>
      <div class="hidden md:flex items-center gap-2 text-sm text-[var(--muted)]">
        <span class="kbd">IRR Pro</span><span class="kbd">Tax Cap</span><span class="kbd">Compare</span><span class="kbd">Sensitivity</span>
      </div>
    </div>
    <div class="hidden md:block">
      <div class="seg">
        <button class="active" data-view="simple">Simple</button>
        <button data-view="advanced">Advanced</button>
        <button data-view="charts">Charts</button>
        <button data-view="about">About</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap space-y-5 pb-24">
  <!-- KPI -->
  <section class="flex gap-3 overflow-x-auto snap-x">
    <div class="kpi"><div class="text-sm text-[var(--muted)]">IRR ต่อปี (Annualized)</div><div id="k-irr-ann" class="val">—</div></div>
    <div class="kpi"><div class="text-sm text-[var(--muted)]">IRR ต่อ “งวด”</div><div id="k-irr-per" class="val">—</div></div>
    <div class="kpi"><div class="text-sm text-[var(--muted)]">ลงทุนสุทธิ (ออก)</div><div id="k-out" class="val">—</div></div>
    <div class="kpi"><div class="text-sm text-[var(--muted)]">เงินรับรวม (เข้า)</div><div id="k-in" class="val">—</div></div>
  </section>

  <!-- Global Controls -->
  <section class="card p-4">
    <div class="grid1 grid2-sm md:grid-cols-4">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">ความถี่งวด</label>
        <select id="freq" class="input">
          <option value="" selected disabled>เลือกความถี่งวด</option>
          <option value="1">รายปี (1 งวด/ปี)</option>
          <option value="2">รายครึ่งปี (2 งวด/ปี)</option>
          <option value="4">รายไตรมาส (4 งวด/ปี)</option>
          <option value="12">รายเดือน (12 งวด/ปี)</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">จำนวนงวดทั้งหมด</label>
        <input id="periods" type="number" class="input" min="1" max="600" placeholder="เช่น 19" inputmode="numeric">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">งวดที่ “จ่ายเบี้ย”</label>
        <input id="payPeriods" type="number" class="input" min="0" placeholder="เช่น 10" inputmode="numeric">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">ดำเนินการ</label>
        <div class="flex gap-2">
          <button class="btn w-full" id="saveLS">บันทึก</button>
          <button class="btn w-full" id="loadLS">โหลด</button>
          <button class="btn w-full" id="printBtn">พิมพ์</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SIMPLE -->
  <section id="view-simple" class="card p-4">
    <div class="font-semibold mb-2">Simple (ตาม 5 ข้อมูลที่ผู้ใช้ทราบ)</div>
    <div class="grid1 grid2-sm md:grid-cols-3">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เบี้ยต่อ “งวด”</label>
        <input id="s-premium" type="number" class="input" step="0.01" placeholder="เช่น 50000" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เงินคืนระหว่างงวด (คงที่)</label>
        <input id="s-interim" type="number" class="input" step="0.01" placeholder="เช่น 3000" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เริ่มรับงวดที่</label>
        <input id="s-interim-start" type="number" class="input" min="1" placeholder="เช่น 1" inputmode="numeric">
      </div>
    </div>
    <div class="grid1 grid2-sm md:grid-cols-3 mt-3">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">จำนวนงวดที่รับระหว่างงวด</label>
        <input id="s-interim-count" type="number" class="input" min="0" placeholder="เช่น 19" inputmode="numeric">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เงินก้อนสุดท้าย (งวดสุดท้าย)</label>
        <input id="s-final" type="number" class="input" step="0.01" placeholder="เช่น 0" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">อัตราลดหย่อนภาษี (% ของเบี้ยที่จ่าย)</label>
        <input id="s-tax-rate" type="number" class="input" step="0.01" placeholder="เช่น 15" inputmode="decimal">
      </div>
    </div>
    <div class="flex flex-wrap gap-2 mt-3">
      <button class="btn btn-primary w-full sm:w-auto" id="applySimple">คำนวณ/เติมค่า</button>
      <div class="hint">* ต้องกรอก “จำนวนงวดทั้งหมด” ก่อน</div>
    </div>
  </section>

  <!-- ADVANCED -->
  <section id="view-advanced" class="card p-4 hidden">
    <div class="font-semibold mb-2">Advanced (เงินคืนหลายช่วง + ตารางแก้รายงวด + ค่าธรรมเนียม)</div>
    <div class="grid1 grid2-sm md:grid-cols-4">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เบี้ย/งวด</label>
        <input id="premium" type="number" class="input" step="0.01" placeholder="เช่น 50000" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">ค่าธรรมเนียม/งวด (หักออก)</label>
        <input id="feePerPeriod" type="number" class="input" step="0.01" placeholder="เช่น 0" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">อัตราลดหย่อนภาษี (%)</label>
        <input id="taxRate" type="number" class="input" step="0.01" placeholder="เช่น 15" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เงินก้อนสุดท้าย</label>
        <input id="finalLump" type="number" class="input" step="0.01" placeholder="เช่น 0" inputmode="decimal">
      </div>
    </div>

    <div class="mt-3">
      <div class="flex items-center justify-between gap-3">
        <div class="font-semibold">กำหนดเงินคืนระหว่างงวด (หลายช่วง)</div>
        <div class="hint">คลิก “เพิ่มช่วง” เพื่อกำหนดได้ไม่จำกัด</div>
      </div>
      <div id="tiers" class="space-y-2 mt-2"></div>
      <div class="grid1 grid2 gap-2 mt-2">
        <button class="btn" id="addTier">+ เพิ่มช่วง</button>
        <div class="flex gap-2">
          <button class="btn w-full" id="fillZero">กำหนด 0 ทุกงวด</button>
          <button class="btn w-full" id="clearInterim">ล้างเงินคืนทั้งหมด</button>
          <button class="btn btn-primary w-full" id="applyTiers">เติมตามช่วง</button>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <div class="text-sm font-semibold mb-2">ตารางแก้ไขเงินคืนรายงวด</div>
      <div class="overflow-x-auto -mx-2 md:mx-0 px-2 md:px-0">
        <table class="table">
          <thead>
            <tr class="bg-white">
              <th>งวด</th><th>เบี้ย</th><th>ค่าธรรมเนียม</th>
              <th style="min-width:200px">เงินคืนระหว่างงวด (แก้ไขได้)</th>
              <th>ลดหย่อนภาษี</th><th>ก้อนสุดท้าย</th><th>สุทธิ (Total)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr class="bg-slate-50 font-semibold">
              <td>รวม</td><td id="sPrem">—</td><td id="sFee">—</td>
              <td id="sInterim">—</td><td id="sTax">—</td><td id="sFinal">—</td><td id="sTotal">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section id="view-charts" class="card p-4 hidden">
    <div class="font-semibold mb-2">Charts</div>
    <div class="grid1 md:grid-cols-2 gap-3">
      <div><div class="text-sm text-[var(--muted)] mb-1">Cashflow by Period</div><div class="w-full" style="height:220px"><canvas id="cfChart"></canvas></div></div>
      <div><div class="text-sm text-[var(--muted)] mb-1">Cumulative Cashflow</div><div class="w-full" style="height:220px"><canvas id="cumChart"></canvas></div></div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="view-about" class="card p-4 hidden">
    <div class="font-semibold mb-2">แนวทางและข้อควรทราบ</div>
    <ul class="list-disc pl-6 space-y-1 text-sm">
      <li>IRR ต่อ “งวด” แปลงเป็น IRR ต่อปีด้วย <code>(1 + r_period)^(งวด/ปี) − 1</code></li>
      <li>ลดหย่อนภาษีตั้งค่าได้ทั้ง % เพดาน และช่วงงวด</li>
    </ul>
  </section>
</main>

<nav class="bottom md:hidden">
  <div class="wrap px-0">
    <div class="grid grid-cols-4 gap-2">
      <button class="tab active" data-view="simple">Simple</button>
      <button class="tab" data-view="advanced">Advanced</button>
      <button class="tab" data-view="charts">Charts</button>
      <button class="tab" data-view="about">About</button>
    </div>
  </div>
</nav>

<script>
/* ===== Utilities ===== */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:2}) : '—');
const pct = (x)=> (isFinite(x) ? (x*100).toFixed(4)+'%' : '—');

/* ===== IRR ===== */
function npv(rate, cf){ let s=0; for(let t=0;t<cf.length;t++) s += cf[t]/Math.pow(1+rate,t); return s; }
function dnpv(rate, cf){ let s=0; for(let t=1;t<cf.length;t++) s += -t*cf[t]/Math.pow(1+rate,t+1); return s; }
function irr(cf){
  if(!(cf.some(v=>v>0) && cf.some(v=>v<0))) return NaN;
  let r=0.1;
  for(let i=0;i<60;i++){
    const f=npv(r,cf), df=dnpv(r,cf);
    if(Math.abs(f)<1e-9) return r;
    if(df===0 || !isFinite(df)) break;
    r = r - f/df;
    if(!isFinite(r) || r<=-0.999999) break;
  }
  let lo=-0.9999, hi=10, flo=npv(lo,cf), fhi=npv(hi,cf);
  if(flo*fhi>0){ for(let k=0;k<10;k++){ hi*=2; fhi=npv(hi,cf); if(flo*fhi<=0) break; } if(flo*fhi>0) return NaN; }
  for(let i=0;i<200;i++){
    const mid=(lo+hi)/2, fm=npv(mid,cf);
    if(Math.abs(fm)<1e-9) return mid;
    if(flo*fm<=0){ hi=mid; fhi=fm; } else { lo=mid; flo=fm; }
  }
  return (lo+hi)/2;
}

/* ===== State ===== */
const state = {
  freq: undefined, periods: undefined, payPeriods: undefined,
  premium: undefined, feePerPeriod: undefined, finalLump: undefined,
  taxRate: undefined, taxStart: undefined, taxEnd: undefined,
  taxCapPerPeriod: undefined, taxCapContract: undefined, taxOnlyWhenPay: true,
  interim: [], tiers: [], scenarios: {A:null,B:null,C:null},
  charts: {cf:null, cum:null}
};

/* ===== Builders ===== */
function buildRows(){
  const N = state.periods|0;
  const payN = Math.max(0, Math.min(state.payPeriods|0, N));
  while(state.interim.length < N) state.interim.push(0);
  if(state.interim.length > N) state.interim = state.interim.slice(0,N);

  const rows = [];
  let taxAccum = 0;
  for(let i=0;i<N;i++){
    const p = i+1;
    const pay = (p<=payN) ? Number(state.premium||0) : 0;
    const fee = Number(state.feePerPeriod||0);

    const eligible = (state.taxStart && state.taxEnd) ? (p>=state.taxStart && p<=state.taxEnd) : false;
    let tax = 0;
    if(eligible){
      const rate = Number(state.taxRate||0);
      const capP = Number(state.taxCapPerPeriod||Infinity);
      const capC = Number(state.taxCapContract||Infinity);
      tax = Math.min(pay*rate, capP);
      if(taxAccum + tax > capC) tax = Math.max(0, capC - taxAccum);
    }
    taxAccum += tax;

    const between = Number(state.interim[i]||0);
    const final = (p===N) ? Number(state.finalLump||0) : 0;
    const total = (between + tax + final) - pay - fee;
    rows.push({period:p, pay, fee, between, tax, final, total});
  }
  return rows;
}
function cashflows(){ return buildRows().map(r=>r.total); }

/* ===== Renderers ===== */
function refreshKPIs(){
  const cf = cashflows();
  const rPer = irr(cf);
  const k = (state.freq>0) ? Math.max(1, state.freq) : 1;
  const rAnn = isFinite(rPer) ? Math.pow(1+rPer, k)-1 : NaN;

  const rows = buildRows();
  const out = rows.filter(r=>r.total<0).reduce((a,r)=>a+r.total,0);
  const inn = rows.filter(r=>r.total>0).reduce((a,r)=>a+r.total,0);

  $('k-irr-per').textContent = pct(rPer);
  $('k-irr-ann').textContent = pct(rAnn);
  $('k-out').textContent = fmt(out);
  $('k-in').textContent = fmt(inn);
}
function renderTable(){
  const rows = buildRows();
  $('tbody').innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${r.period}</td>
      <td>${fmt(-r.pay)}</td>
      <td>${fmt(-r.fee)}</td>
      <td><input class="input" type="number" step="0.01" data-row="${i}" value="${r.between||0}" inputmode="decimal"></td>
      <td>${fmt(r.tax)}</td>
      <td>${fmt(r.final)}</td>
      <td>${fmt(r.total)}</td>
    </tr>
  `).join('');
  $('sPrem').textContent    = fmt(rows.reduce((a,r)=>a - r.pay, 0));
  $('sFee').textContent     = fmt(rows.reduce((a,r)=>a - r.fee, 0));
  $('sInterim').textContent = fmt(rows.reduce((a,r)=>a + r.between, 0));
  $('sTax').textContent     = fmt(rows.reduce((a,r)=>a + r.tax, 0));
  $('sFinal').textContent   = fmt(rows.reduce((a,r)=>a + r.final, 0));
  $('sTotal').textContent   = fmt(rows.reduce((a,r)=>a + r.total, 0));
}
function renderCharts(){
  const rows = buildRows();
  if(state.charts.cf){ state.charts.cf.destroy(); state.charts.cf=null; }
  if(state.charts.cum){ state.charts.cum.destroy(); state.charts.cum=null; }
  if(rows.length===0) return;

  const labels = rows.map(r=>`งวด ${r.period}`);
  const cf = rows.map(r=>r.total);
  const cum = rows.reduce((arr,v)=>{ arr.push((arr.at(-1)||0)+v); return arr; }, []);

  state.charts.cf = new Chart(document.getElementById('cfChart').getContext('2d'), {
    type:'bar', data:{ labels, datasets:[{ label:'Total', data: cf }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
      scales:{y:{ticks:{callback:v=>Number(v).toLocaleString()}}}}
  });
  state.charts.cum = new Chart(document.getElementById('cumChart').getContext('2d'), {
    type:'line', data:{ labels, datasets:[{ label:'Cumulative', data: cum, borderWidth:2, fill:false }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
      scales:{y:{ticks:{callback:v=>Number(v).toLocaleString()}}}}
  });
}
function renderTiers(){
  const box = $('tiers');
  if(!box) return;
  box.innerHTML = state.tiers.map((t,idx)=>`
    <div class="grid1 md:grid-cols-4 gap-2">
      <div><input class="input" type="number" min="1" step="1" data-tier="${idx}" data-k="from" value="${t.from ?? ''}" placeholder="จากงวด" inputmode="numeric"></div>
      <div><input class="input" type="number" min="1" step="1" data-tier="${idx}" data-k="to" value="${t.to ?? ''}" placeholder="ถึงงวด" inputmode="numeric"></div>
      <div><input class="input" type="number" step="0.01" data-tier="${idx}" data-k="amt" value="${t.amt ?? ''}" placeholder="จำนวนเงิน" inputmode="decimal"></div>
      <div class="flex gap-2"><button class="btn w-full" data-tier-del="${idx}">ลบช่วง</button></div>
    </div>
  `).join('');
}
function syncTiersFromDOM(){
  document.querySelectorAll('#tiers [data-tier][data-k]').forEach(el=>{
    const i=+el.dataset.tier, k=el.dataset.k;
    const val = el.value==='' ? undefined : (k==='amt' ? Number(el.value) : Number(el.value));
    if(state.tiers[i]) state.tiers[i][k]=val;
  });
}

/* ===== Events ===== */
function bind(){
  document.querySelectorAll('[data-view]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('[data-view]').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll(`[data-view="${b.dataset.view}"]`).forEach(x=>x.classList.add('active'));
      ['simple','advanced','charts','about'].forEach(v=>{
        const el = document.getElementById('view-'+v);
        if(el) el.classList.toggle('hidden', v!==b.dataset.view);
      });
      if(b.dataset.view==='charts') renderCharts();
      window.scrollTo({top:0, behavior:'smooth'});
    });
  });

  // Global
  $('freq').onchange = ()=>{ state.freq = Number($('freq').value||0) || undefined; refreshAll(); };
  $('periods').oninput = ()=>{ state.periods = Number($('periods').value||0) || undefined; refreshAll(); };
  $('payPeriods').oninput = ()=>{ state.payPeriods = Number($('payPeriods').value||0) || undefined; refreshAll(); };
  $('saveLS').onclick = ()=>{ localStorage.setItem('ins_full_state', JSON.stringify(snapshot())); alert('บันทึกไว้ในอุปกรณ์แล้ว'); };
  $('loadLS').onclick = ()=>{ const raw = localStorage.getItem('ins_full_state'); if(!raw) return alert('ยังไม่มีข้อมูลที่บันทึก'); try{ restore(JSON.parse(raw)); }catch(e){ alert('ข้อมูลไม่ถูกต้อง'); } };
  $('printBtn').onclick = ()=> window.print();

  // Simple
  $('applySimple').onclick = ()=>{
    const N = Number($('periods').value||0);
    if(!N){ alert('กรุณาระบุ "จำนวนงวดทั้งหมด" ก่อน'); return; }
    state.premium = Number($('s-premium').value||0);
    const sInter = Number($('s-interim').value||0);
    const sStart = Math.max(1, Number($('s-interim-start').value||1));
    const sCount = Math.max(0, Number($('s-interim-count').value||0));
    state.finalLump = Number($('s-final').value||0);
    state.taxRate = Number($('s-tax-rate').value||0)/100 || 0;

    state.interim = new Array(N).fill(0);
    for(let i=0;i<sCount;i++){
      const idx = sStart-1+i; if(idx<state.interim.length) state.interim[idx] = sInter;
    }
    refreshAll();
  };

  // Table inline edit
  $('tbody').addEventListener('input', (e)=>{
    const t = e.target; if(!t.matches('input[data-row]')) return;
    const idx = +t.dataset.row; state.interim[idx] = Number(t.value||0); refreshAll();
  });

  // Tiers
  $('addTier').onclick = ()=>{ state.tiers.push({from:undefined,to:undefined,amt:undefined}); renderTiers(); };
  $('tiers').addEventListener('input', (e)=>{
    const t=e.target; if(!t.matches('[data-tier]')) return;
    const i=+t.dataset.tier, k=t.dataset.k;
    state.tiers[i][k] = (t.value===''?undefined:(k==='amt'?Number(t.value):Number(t.value)));
  });
  $('tiers').addEventListener('click', (e)=>{
    const b=e.target; if(!b.matches('[data-tier-del]')) return;
    const i=+b.dataset.tierDel; state.tiers.splice(i,1); renderTiers();
  });
  $('fillZero').onclick = ()=>{ const N = state.periods|0; state.interim = new Array(N).fill(0); refreshAll(); };
  $('clearInterim').onclick = ()=>{ state.interim = []; refreshAll(); };
  $('applyTiers').onclick = ()=>{
    // เก็บค่าที่พิมพ์ล่าสุดก่อนคำนวณ (แก้ปัญหาข้อความหาย)
    syncTiersFromDOM();
    const N = state.periods|0;
    if(!N){ alert('กรุณาระบุ "จำนวนงวดทั้งหมด" ก่อน'); return; }
    if(state.interim.length!==N) state.interim = new Array(N).fill(0);
    for(const t of state.tiers){
      if(!t) continue;
      const s = Math.max(1, Math.min(N, (t.from|0)));
      const e = Math.max(1, Math.min(N, (t.to|0)));
      if(!s || !e) continue;
      for(let i=s-1;i<=e-1;i++) state.interim[i] = Number(t.amt||0);
    }
    refreshAll();
  });
}

/* ===== Snapshot ===== */
function snapshot(){
  return {
    freq: state.freq, periods: state.periods, payPeriods: state.payPeriods,
    premium: state.premium, feePerPeriod: state.feePerPeriod,
    finalLump: state.finalLump, taxRate: state.taxRate,
    taxStart: state.taxStart, taxEnd: state.taxEnd,
    taxCapPerPeriod: state.taxCapPerPeriod, taxCapContract: state.taxCapContract,
    taxOnlyWhenPay: state.taxOnlyWhenPay, interim: [...state.interim], tiers:[...state.tiers]
  };
}
function restore(snap){ Object.assign(state, snap); refreshAll(); }

/* ===== Refresh ===== */
function refreshAll(){
  const N = state.periods|0;
  while(state.interim.length < N) state.interim.push(0);
  if(state.interim.length > N) state.interim = state.interim.slice(0,N);

  // สะท้อนค่าแบบ "ไม่ทับค่าที่ว่าง"
  $('freq').value = (state.freq ?? '');
  $('periods').value = (state.periods ?? '');
  $('payPeriods').value = (state.payPeriods ?? '');
  if($('premium')) $('premium').value = (state.premium ?? '');
  if($('feePerPeriod')) $('feePerPeriod').value = (state.feePerPeriod ?? '');
  if($('taxRate')) $('taxRate').value = (state.taxRate!=null ? (state.taxRate*100).toFixed(2) : '');
  if($('finalLump')) $('finalLump').value = (state.finalLump ?? '');

  renderTiers();
  renderTable();
  refreshKPIs();

  const chartsVisible = !document.getElementById('view-charts').classList.contains('hidden');
  if(chartsVisible) renderCharts();
}

/* ===== Init: no preset ===== */
function init(){ bind(); refreshAll(); }
init();
</script>
</body>
</html>
