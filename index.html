<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Insurance Return Studio • IRR ระดับโปร</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg-from:#f8fafc; --bg-to:#eef2ff; --card:#ffffff; --line:#e5e7eb;
    --text:#0f172a; --muted:#64748b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif;
    background:
      radial-gradient(1200px 600px at 20% -10%, #eef2ff 0%, transparent 60%),
      linear-gradient(180deg,var(--bg-from),var(--bg-to));
    color:var(--text);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  main{ padding-bottom:calc(96px + env(safe-area-inset-bottom,0)); }
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.08)}
  .btn{border:1px solid var(--line);border-radius:12px;padding:.9rem 1rem;line-height:1}
  .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
  .seg{border:1px solid var(--line);border-radius:999px;padding:.35rem;display:inline-flex;gap:.25rem;background:#fff}
  .seg button{padding:.55rem .95rem;border-radius:999px;font-weight:600}
  .seg .active{background:#0f172a;color:#fff}
  .tab.active{background:#0f172a;color:#fff}
  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:1rem .95rem;font-size:1rem}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{border-bottom:1px solid var(--line);padding:.75rem;text-align:right;font-size:.95rem;white-space:nowrap}
  .table th:first-child,.table td:first-child{text-align:center}
  .kpi{border:1px solid var(--line);border-radius:14px;padding:16px;background:#fff;min-width:240px}
  .kpi .val{font-size:1.9rem;font-weight:700}
  .hint{font-size:.86rem;color:var(--muted)}
  .kbd{font-size:.75rem;border:1px dashed var(--line);background:#fff;border-radius:8px;padding:.2rem .45rem;color:var(--muted)}
  .grid1{display:grid;grid-template-columns:1fr;gap:.75rem}
  @media(min-width:640px){ .grid2-sm{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:768px){
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem}
  }
  header.appbar{position:sticky;top:0;z-index:40;backdrop-filter:blur(8px);background:rgba(255,255,255,.7);border-bottom:1px solid var(--line)}
  nav.bottom{
    position:sticky;bottom:0;z-index:40;background:rgba(255,255,255,.9);
    backdrop-filter:blur(8px);border-top:1px solid var(--line);
    padding:6px 8px calc(6px + env(safe-area-inset-bottom,0)) 8px
  }
  nav.bottom .tab{flex:1;border-radius:12px;padding:.75rem .4rem;text-align:center;font-size:.9rem;border:1px solid transparent}
  .flash{animation:flash 1.2s ease}
  @keyframes flash{0%{background:rgba(99,102,241,.08)}100%{background:transparent}}
</style>
</head>
<body>
<!-- Top App Bar -->
<header class="appbar">
  <div class="wrap py-3 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="text-lg font-semibold">Insurance Return Studio</div>
      <div class="hidden md:flex items-center gap-2 text-sm text-[var(--muted)]">
        <span class="kbd">IRR Pro</span><span class="kbd">Tax Cap</span><span class="kbd">Compare</span><span class="kbd">Sensitivity</span>
      </div>
    </div>
    <div class="hidden md:block">
      <div class="seg" role="tablist" aria-label="Primary tabs">
        <button type="button" id="tabTop-simple"   class="tab" data-view="simple"   role="tab" aria-controls="view-simple">Simple</button>
        <button type="button" id="tabTop-advanced" class="tab" data-view="advanced" role="tab" aria-controls="view-advanced">Advanced</button>
        <button type="button" id="tabTop-charts"   class="tab" data-view="charts"   role="tab" aria-controls="view-charts">Charts</button>
        <button type="button" id="tabTop-about"    class="tab" data-view="about"    role="tab" aria-controls="view-about">About</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap space-y-5">
  <!-- KPI -->
  <section class="flex gap-3 overflow-x-auto snap-x">
    <div class="kpi"><div class="text-sm text-[var(--muted)]">IRR ต่อปี (Annualized)</div><div id="k-irr-ann" class="val">—</div></div>
    <div class="kpi"><div class="text-sm text-[var(--muted)]">IRR ต่อ “งวด”</div><div id="k-irr-per" class="val">—</div></div>
    <div class="kpi"><div class="text-sm text-[var(--muted)]">ลงทุนสุทธิ (ออก)</div><div id="k-out" class="val">—</div></div>
    <div class="kpi"><div class="text-sm text-[var(--muted)]">เงินรับรวม (เข้า)</div><div id="k-in" class="val">—</div></div>
  </section>

  <!-- Global Controls -->
  <section class="card p-4">
    <div class="grid1 grid2-sm md:grid-cols-4">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">ความถี่งวด</label>
        <select id="freq" class="input">
          <option value="" selected disabled>เลือกความถี่งวด</option>
          <option value="1">รายปี (1 งวด/ปี)</option>
          <option value="2">รายครึ่งปี (2 งวด/ปี)</option>
          <option value="4">รายไตรมาส (4 งวด/ปี)</option>
          <option value="12">รายเดือน (12 งวด/ปี)</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">จำนวนงวดทั้งหมด</label>
        <input id="periods" type="number" class="input" min="1" max="600" placeholder="เช่น 19" inputmode="numeric">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">งวดที่ “จ่ายเบี้ย”</label>
        <input id="payPeriods" type="number" class="input" min="0" placeholder="เช่น 10" inputmode="numeric">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">ดำเนินการ</label>
        <div class="flex gap-2">
          <button type="button" class="btn w-full" id="saveLS">บันทึก</button>
          <button type="button" class="btn w-full" id="loadLS">โหลด</button>
          <button type="button" class="btn w-full" id="printBtn">พิมพ์</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SIMPLE -->
  <section id="view-simple" class="card p-4" role="tabpanel" aria-labelledby="tabTop-simple">
    <div class="font-semibold mb-2">Simple (ตาม 5 ข้อมูลที่ผู้ใช้ทราบ)</div>
    <div class="grid1 grid2-sm md:grid-cols-3">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เบี้ยต่อ “งวด”</label>
        <input id="s-premium" type="number" class="input" step="0.01" placeholder="เช่น 50000" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เงินคืนระหว่างงวด (คงที่)</label>
        <input id="s-interim" type="number" class="input" step="0.01" placeholder="เช่น 3000" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เริ่มรับงวดที่</label>
        <input id="s-interim-start" type="number" class="input" min="1" placeholder="เช่น 1" inputmode="numeric">
      </div>
    </div>
    <div class="grid1 grid2-sm md:grid-cols-3 mt-3">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">จำนวนงวดที่รับระหว่างงวด</label>
        <input id="s-interim-count" type="number" class="input" min="0" placeholder="เช่น 19" inputmode="numeric">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เงินก้อนสุดท้าย (งวดสุดท้าย)</label>
        <input id="s-final" type="number" class="input" step="0.01" placeholder="เช่น 0" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">อัตราลดหย่อนภาษี (% ของเบี้ยที่จ่าย)</label>
        <input id="s-tax-rate" type="number" class="input" step="0.01" placeholder="เช่น 15" inputmode="decimal">
      </div>
    </div>
    <div class="flex flex-wrap gap-2 mt-3">
      <button type="button" class="btn btn-primary w-full sm:w-auto" id="applySimple">คำนวณ/เติมค่า</button>
      <div class="hint">* ต้องกรอก “จำนวนงวดทั้งหมด” ก่อน</div>
    </div>
  </section>

  <!-- ADVANCED -->
  <section id="view-advanced" class="card p-4 hidden" role="tabpanel" aria-hidden="true" aria-labelledby="tabTop-advanced">
    <div class="font-semibold mb-2">Advanced (เงินคืนหลายช่วง + ตารางแก้รายงวด + ค่าธรรมเนียม)</div>
    <div class="grid1 grid2-sm md:grid-cols-4">
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เบี้ย/งวด</label>
        <input id="premium" type="number" class="input" step="0.01" placeholder="เช่น 50000" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">ค่าธรรมเนียม/งวด (หักออก)</label>
        <input id="feePerPeriod" type="number" class="input" step="0.01" placeholder="เช่น 0" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">อัตราลดหย่อนภาษี (%)</label>
        <input id="taxRate" type="number" class="input" step="0.01" placeholder="เช่น 15" inputmode="decimal">
      </div>
      <div>
        <label class="block text-sm text-[var(--muted)] mb-1">เงินก้อนสุดท้าย</label>
        <input id="finalLump" type="number" class="input" step="0.01" placeholder="เช่น 0" inputmode="decimal">
      </div>
    </div>

    <div class="mt-3">
      <div class="flex items-center justify-between gap-3">
        <div class="font-semibold">กำหนดเงินคืนระหว่างงวด (หลายช่วง)</div>
        <div class="hint">คลิก “เพิ่มช่วง” เพื่อกำหนดได้ไม่จำกัด</div>
      </div>
      <div id="tiers" class="space-y-2 mt-2"></div>
      <div class="grid1 grid2 gap-2 mt-2">
        <button type="button" class="btn" id="addTier">+ เพิ่มช่วง</button>
        <div class="flex gap-2">
          <button type="button" class="btn w-full" id="fillZero">กำหนด 0 ทุกงวด</button>
          <button type="button" class="btn w-full" id="clearInterim">ล้างเงินคืนทั้งหมด</button>
          <button type="button" class="btn btn-primary w-full" id="applyTiers">เติมตามช่วง</button>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <div class="text-sm font-semibold mb-2">ตารางแก้ไขเงินคืนรายงวด</div>
      <div class="overflow-x-auto -mx-2 md:mx-0 px-2 md:px-0">
        <table class="table">
          <thead>
            <tr class="bg-white">
              <th>งวด</th><th>เบี้ย</th><th>ค่าธรรมเนียม</th>
              <th style="min-width:200px">เงินคืนระหว่างงวด (แก้ไขได้)</th>
              <th>ลดหย่อนภาษี</th><th>ก้อนสุดท้าย</th><th>สุทธิ (Total)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr class="bg-slate-50 font-semibold">
              <td>รวม</td><td id="sPrem">—</td><td id="sFee">—</td>
              <td id="sInterim">—</td><td id="sTax">—</td><td id="sFinal">—</td><td id="sTotal">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section id="view-charts" class="card p-4 hidden" role="tabpanel" aria-hidden="true" aria-labelledby="tabTop-charts">
    <div class="font-semibold mb-2">Charts</div>
    <div class="grid1 md:grid-cols-2 gap-3">
      <div><div class="text-sm text-[var(--muted)] mb-1">Cashflow by Period</div><div class="w-full" style="height:220px"><canvas id="cfChart"></canvas></div></div>
      <div><div class="text-sm text-[var(--muted)] mb-1">Cumulative Cashflow</div><div class="w-full" style="height:220px"><canvas id="cumChart"></canvas></div></div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="view-about" class="card p-4 hidden" role="tabpanel" aria-hidden="true" aria-labelledby="tabTop-about">
    <div class="font-semibold mb-2">แนวทางและข้อควรทราบ</div>
    <ul class="list-disc pl-6 space-y-1 text-sm">
      <li>IRR ต่อ “งวด” แปลงเป็น IRR ต่อปีด้วย <code>(1 + r_period)^(งวด/ปี) − 1</code></li>
      <li>ภาษี: คิดสิทธิ “ต่อปีที่มีจ่ายเบี้ยจริง” และกระจายตามสัดส่วนเบี้ยของปีนั้น</li>
    </ul>
  </section>
</main>

<!-- Bottom tabs (mobile) -->
<nav class="bottom md:hidden">
  <div class="wrap px-0">
    <div class="grid grid-cols-4 gap-2" role="tablist" aria-label="Bottom tabs">
      <button type="button" id="tabBot-simple"   class="tab" data-view="simple"   role="tab" aria-controls="view-simple">Simple</button>
      <button type="button" id="tabBot-advanced" class="tab" data-view="advanced" role="tab" aria-controls="view-advanced">Advanced</button>
      <button type="button" id="tabBot-charts"   class="tab" data-view="charts"   role="tab" aria-controls="view-charts">Charts</button>
      <button type="button" id="tabBot-about"    class="tab" data-view="about"    role="tab" aria-controls="view-about">About</button>
    </div>
  </div>
</nav>

<script>
/* ===== Utilities ===== */
function $(id){ return document.getElementById(id); }
function fmt(n){ return (isFinite(n) ? Number(n).toLocaleString(undefined,{maximumFractionDigits:2}) : '—'); }
function pct(x){ return (isFinite(x) ? (x*100).toFixed(4)+'%' : '—'); }
function toNum(v){ var s=(v==null?'':String(v)).trim().replace(',', '.'); var n=Number(s); return (isFinite(n)? n : 0); }
function isFiniteNum(v){ return typeof v==='number' && isFinite(v); }

/* ===== IRR ===== */
function npv(rate, cf){ var s=0; for(var t=0;t<cf.length;t++) s += cf[t]/Math.pow(1+rate,t); return s; }
function dnpv(rate, cf){ var s=0; for(var t=1;t<cf.length;t++) s += -t*cf[t]/Math.pow(1+rate,t+1); return s; }
function irr(cf){
  var pos=false, neg=false;
  for(var k=0;k<cf.length;k++){ if(cf[k]>0) pos=true; if(cf[k]<0) neg=true; }
  if(!(pos&&neg)) return NaN;
  var r=0.1;
  for(var i=0;i<60;i++){
    var f=npv(r,cf), df=dnpv(r,cf);
    if(Math.abs(f)<1e-9) return r;
    if(df===0 || !isFinite(df)) break;
    r = r - f/df;
    if(!isFinite(r) || r<=-0.999999) break;
  }
  var lo=-0.9999, hi=10, flo=npv(lo,cf), fhi=npv(hi,cf);
  if(flo*fhi>0){ for(var j=0;j<10;j++){ hi*=2; fhi=npv(hi,cf); if(flo*fhi<=0) break; } if(flo*fhi>0) return NaN; }
  for(var m=0;m<200;m++){
    var mid=(lo+hi)/2, fm=npv(mid,cf);
    if(Math.abs(fm)<1e-9) return mid;
    if(flo*fm<=0){ hi=mid; fhi=fm; } else { lo=mid; flo=fm; }
  }
  return (lo+hi)/2;
}

/* ===== State ===== */
var state = {
  freq: undefined, periods: undefined, payPeriods: undefined,
  premium: undefined, feePerPeriod: undefined, finalLump: undefined,
  taxRate: undefined, taxStart: undefined, taxEnd: undefined,
  taxCapPerPeriod: undefined, // ใช้เป็น “เพดานต่อปี”
  taxCapContract: undefined,  // เพดานรวมสัญญา
  taxOnlyWhenPay: true,
  interim: [], tiers: [], charts: {cf:null, cum:null}
};

function ensureTaxDefaults(){
  if (isFinite(state.periods) && state.periods>0){
    if (state.taxStart==null) state.taxStart = 1;
    if (state.taxEnd==null)   state.taxEnd   = state.periods;
  }
  if (state.taxOnlyWhenPay==null) state.taxOnlyWhenPay = true;
}

/* ===== Core builder (ภาษีรายปี pro-rata) ===== */
function buildRows(){
  var N = state.periods|0;
  var inferredFreq = (N>=12 ? 12 : 1);                          // เดาความถี่ถ้าไม่ตั้งค่า
  var freq = (state.freq && state.freq>0) ? state.freq|0 : inferredFreq;
  var payN = Math.max(0, Math.min(state.payPeriods|0, N));

  while(state.interim.length < N) state.interim.push(0);
  if(state.interim.length > N) state.interim = state.interim.slice(0,N);

  ensureTaxDefaults();

  function yearOf(p){ return Math.floor((p-1)/freq)+1; }
  var totalYears = yearOf(Math.max(N,1));

  // รวมเบี้ยต่อปี (เฉพาะงวดที่จ่ายจริง)
  var yearPaySum = Array.from({length: totalYears+1}, ()=>0);
  for(var p=1;p<=N;p++){
    var pay = (p<=payN) ? (toNum(state.premium)||0) : 0;
    if(pay>0) yearPaySum[yearOf(p)] += pay;
  }

  var rate   = toNum(state.taxRate)||0;
  var capY   = (state.taxCapPerPeriod==null ? 9e14 : toNum(state.taxCapPerPeriod));
  var capAll = (state.taxCapContract==null ? 9e14 : toNum(state.taxCapContract));

  var yearTaxTotal  = Array.from({length: totalYears+1}, ()=>0);
  var yearTaxRemain = Array.from({length: totalYears+1}, ()=>0);
  for(var y=1;y<=totalYears;y++){
    var base = yearPaySum[y] * rate;
    yearTaxTotal[y]  = Math.min(base, capY);
    yearTaxRemain[y] = yearTaxTotal[y];
  }

  var rows = [];
  var taxAccumContract = 0;

  for(var i=0;i<N;i++){
    var p = i+1, y = yearOf(p);

    var pay = (p<=payN) ? (toNum(state.premium)||0) : 0;
    var fee = toNum(state.feePerPeriod)||0;
    var between = toNum(state.interim[i]||0);
    var finalAmt = (p===N) ? (toNum(state.finalLump)||0) : 0;

    var inWindow = (p>=state.taxStart && p<=state.taxEnd);
    var eligible = inWindow && (!state.taxOnlyWhenPay || pay>0);

    var tax = 0;
    if(eligible && rate>0 && yearPaySum[y]>0 && yearTaxRemain[y]>0){
      var share = (pay>0 ? (pay / yearPaySum[y]) : 0);
      tax = yearTaxRemain[y] * share;

      if(taxAccumContract + tax > capAll){
        tax = Math.max(0, capAll - taxAccumContract);
      }
      taxAccumContract += tax;
      yearTaxRemain[y]  = Math.max(0, yearTaxRemain[y] - tax);
    }

    var total = (between + tax + finalAmt) - pay - fee;
    rows.push({ period:p, pay:pay, fee:fee, between:between, tax:tax, final:finalAmt, total:total });
  }

  return rows;
}
function cashflows(rows){ rows = rows || buildRows(); return rows.map(r=>r.total); }

/* ===== Renderers ===== */
function refreshKPIs(rows){
  rows = rows || buildRows();
  var cf = cashflows(rows);
  var rPer = irr(cf);
  var k = (state.freq>0) ? Math.max(1, state.freq) : null;
  var rAnn = (k ? Math.pow(1+rPer, k)-1 : NaN);

  var out=0, inn=0;
  rows.forEach(r=>{ if(r.total<0) out+=r.total; if(r.total>0) inn+=r.total; });

  $('k-irr-per').textContent = pct(rPer);
  $('k-irr-ann').textContent = (k ? pct(rAnn) : '—');
  $('k-out').textContent = fmt(out);
  $('k-in').textContent = fmt(inn);
}
function renderTable(rows){
  rows = rows || buildRows();
  var tb = $('tbody'); if(!tb) return;
  tb.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${r.period}</td>
      <td>${fmt(-r.pay)}</td>
      <td>${fmt(-r.fee)}</td>
      <td><input class="input" type="number" step="0.01" data-row="${i}" value="${r.between||0}" inputmode="decimal"></td>
      <td>${fmt(r.tax)}</td>
      <td>${fmt(r.final)}</td>
      <td>${fmt(r.total)}</td>
    </tr>
  `).join('');

  var sumPrem=0,sumFee=0,sumInterim=0,sumTax=0,sumFinal=0,sumTotal=0;
  rows.forEach(r=>{ sumPrem+=-r.pay; sumFee+=-r.fee; sumInterim+=r.between; sumTax+=r.tax; sumFinal+=r.final; sumTotal+=r.total; });
  if($('sPrem')) $('sPrem').textContent = fmt(sumPrem);
  if($('sFee')) $('sFee').textContent = fmt(sumFee);
  if($('sInterim')) $('sInterim').textContent = fmt(sumInterim);
  if($('sTax')) $('sTax').textContent = fmt(sumTax);
  if($('sFinal')) $('sFinal').textContent = fmt(sumFinal);
  if($('sTotal')) $('sTotal').textContent = fmt(sumTotal);
}
function updateRowAndFooters(idx){
  var rows = buildRows();
  var tb = $('tbody'); if(!tb || !tb.rows[idx]){ renderTable(rows); refreshKPIs(rows); if(!$('view-charts').classList.contains('hidden')) renderCharts(rows); return; }
  var tr = tb.rows[idx], r = rows[idx];
  tr.cells[1].textContent = fmt(-r.pay);
  tr.cells[2].textContent = fmt(-r.fee);
  tr.cells[4].textContent = fmt(r.tax);
  tr.cells[5].textContent = fmt(r.final);
  tr.cells[6].textContent = fmt(r.total);

  var sumPrem=0,sumFee=0,sumInterim=0,sumTax=0,sumFinal=0,sumTotal=0;
  rows.forEach(x=>{ sumPrem+=-x.pay; sumFee+=-x.fee; sumInterim+=x.between; sumTax+=x.tax; sumFinal+=x.final; sumTotal+=x.total; });
  $('sPrem').textContent = fmt(sumPrem);
  $('sFee').textContent  = fmt(sumFee);
  $('sInterim').textContent = fmt(sumInterim);
  $('sTax').textContent  = fmt(sumTax);
  $('sFinal').textContent= fmt(sumFinal);
  $('sTotal').textContent= fmt(sumTotal);

  refreshKPIs(rows);
  if(!$('view-charts').classList.contains('hidden')) renderCharts(rows);
}
function renderCharts(rows){
  rows = rows || buildRows();
  var cfCanvas = $('cfChart'), cumCanvas = $('cumChart');
  if(!cfCanvas || !cumCanvas || !rows.length) return;

  var labels=[], cf=[], cum=[];
  var acc = 0;
  rows.forEach(r=>{ labels.push('งวด '+r.period); cf.push(r.total); acc+=r.total; cum.push(acc); });

  if(!state.charts.cf){
    state.charts.cf = new Chart(cfCanvas.getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Total', data: cf }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{y:{ticks:{callback:v=>Number(v).toLocaleString()}}}}
    });
  }else{
    state.charts.cf.data.labels = labels;
    state.charts.cf.data.datasets[0].data = cf;
    state.charts.cf.update('none');
  }

  if(!state.charts.cum){
    state.charts.cum = new Chart(cumCanvas.getContext('2d'), {
      type:'line',
      data:{ labels, datasets:[{ label:'Cumulative', data: cum, borderWidth:2, fill:false }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{y:{ticks:{callback:v=>Number(v).toLocaleString()}}}}
    });
  }else{
    state.charts.cum.data.labels = labels;
    state.charts.cum.data.datasets[0].data = cum;
    state.charts.cum.update('none');
  }
}
function renderTiers(){
  var box = $('tiers'); if(!box) return;
  box.innerHTML = state.tiers.map((t,idx)=>`
    <div class="grid1 md:grid-cols-4 gap-2 flash">
      <div><input class="input" type="number" min="1" step="1" data-tier="${idx}" data-k="from" value="${t.from??''}" placeholder="จากงวด" inputmode="numeric"></div>
      <div><input class="input" type="number" min="1" step="1" data-tier="${idx}" data-k="to" value="${t.to??''}" placeholder="ถึงงวด" inputmode="numeric"></div>
      <div><input class="input" type="number" step="0.01" data-tier="${idx}" data-k="amt" value="${t.amt??''}" placeholder="จำนวนเงิน" inputmode="decimal"></div>
      <div class="flex gap-2"><button type="button" class="btn w-full" data-tier-del="${idx}">ลบช่วง</button></div>
    </div>
  `).join('');
}
function syncTiersFromDOM(){
  var nodes = document.querySelectorAll('#tiers [data-tier][data-k]');
  nodes.forEach(el=>{
    var idx = +el.getAttribute('data-tier');
    var key = el.getAttribute('data-k');
    var raw = el.value;
    var val = (raw===''? undefined : Number(raw));
    if(!state.tiers[idx]) state.tiers[idx] = {from:undefined,to:undefined,amt:undefined};
    state.tiers[idx][key] = val;
  });
}

/* ===== Tabs ===== */
var allowedViews = ['simple','advanced','charts','about'];
function setView(view){
  if(allowedViews.indexOf(view)===-1) return;
  allowedViews.forEach(v=>{
    var el = $('view-'+v);
    if(el){ var active=(v===view); el.classList.toggle('hidden', !active); el.setAttribute('aria-hidden', active? 'false':'true'); }
  });
  document.querySelectorAll('[data-view]').forEach(b=>{
    var on = (b.getAttribute('data-view')===view);
    b.classList.toggle('active', on);
    b.setAttribute('aria-selected', on? 'true':'false');
  });
  try{ history.replaceState(null, '', '#'+view); }catch(e){}
  if(view==='charts') renderCharts();
}

/* ===== Snapshot / Restore ===== */
function snapshot(){
  return {
    freq: state.freq!=null ? state.freq : '',
    periods: state.periods!=null ? state.periods : '',
    payPeriods: state.payPeriods!=null ? state.payPeriods : '',
    premium: state.premium!=null ? state.premium : '',
    feePerPeriod: state.feePerPeriod!=null ? state.feePerPeriod : '',
    finalLump: state.finalLump!=null ? state.finalLump : '',
    taxRate: state.taxRate!=null ? state.taxRate : '',
    taxStart: state.taxStart!=null ? state.taxStart : '',
    taxEnd: state.taxEnd!=null ? state.taxEnd : '',
    taxCapPerPeriod: state.taxCapPerPeriod!=null ? state.taxCapPerPeriod : 900000000000000,
    taxCapContract: state.taxCapContract!=null ? state.taxCapContract : 900000000000000,
    taxOnlyWhenPay: state.taxOnlyWhenPay!=null ? state.taxOnlyWhenPay : true,
    interim: state.interim.slice(),
    tiers: state.tiers.map(t=> t ? ({from:t.from, to:t.to, amt:t.amt}) : t)
  };
}
function restore(snap){
  var def = snapshot();
  for(var k in def){ if(def.hasOwnProperty(k) && snap && (k in snap)) def[k]=snap[k]; }
  for(var k2 in def){ if(def.hasOwnProperty(k2)) state[k2]=def[k2]; }
  refreshAll();
  var hash = (location.hash||'#simple').replace('#','');
  setView(allowedViews.indexOf(hash)===-1 ? 'simple' : hash);
}

/* ===== Refresh ===== */
function refreshAll(){
  var N = state.periods|0;
  while(state.interim.length < N) state.interim.push(0);
  if(state.interim.length > N) state.interim = state.interim.slice(0,N);

  ensureTaxDefaults();

  if($('freq')) $('freq').value = (state.freq!=null ? String(state.freq) : '');
  if($('periods')) $('periods').value = (state.periods!=null ? state.periods : '');
  if($('payPeriods')) $('payPeriods').value = (state.payPeriods!=null ? state.payPeriods : '');
  if($('premium')) $('premium').value = (state.premium!=null ? state.premium : '');
  if($('feePerPeriod')) $('feePerPeriod').value = (state.feePerPeriod!=null ? state.feePerPeriod : '');
  if($('taxRate')) $('taxRate').value = (state.taxRate!=null ? (state.taxRate*100).toFixed(2) : '');
  if($('finalLump')) $('finalLump').value = (state.finalLump!=null ? state.finalLump : '');

  renderTiers();

  var rows = buildRows();
  renderTable(rows);
  refreshKPIs(rows);

  var chartsVisible = $('view-charts') && !$('view-charts').classList.contains('hidden');
  if(chartsVisible) renderCharts(rows);
}

/* ===== Events ===== */
function bind(){
  // Tabs
  document.querySelectorAll('[data-view]').forEach(b=>{
    b.addEventListener('click', e=>{
      var v = b.getAttribute('data-view'); if(!v || allowedViews.indexOf(v)===-1) return;
      e.preventDefault(); setView(v); window.scrollTo({top:0, behavior:'smooth'});
    });
  });
  window.addEventListener('popstate', ()=>{
    var v = (location.hash||'#simple').slice(1);
    setView(allowedViews.indexOf(v)===-1 ? 'simple' : v);
  });

  // Global inputs
  if($('freq')) $('freq').onchange = function(){ state.freq = toNum(this.value)||undefined; refreshAll(); };
  if($('periods')) $('periods').oninput = function(){ state.periods = toNum(this.value)||undefined; refreshAll(); };
  if($('payPeriods')) $('payPeriods').oninput = function(){ state.payPeriods = toNum(this.value)||undefined; refreshAll(); };

  // Save/Load/Print
  if($('saveLS')) $('saveLS').onclick = function(){ localStorage.setItem('ins_full_state', JSON.stringify(snapshot())); alert('บันทึกไว้ในอุปกรณ์แล้ว'); };
  if($('loadLS')) $('loadLS').onclick = function(){
    var raw = localStorage.getItem('ins_full_state');
    if(!raw) return alert('ยังไม่มีข้อมูลที่บันทึก');
    try{
      var data = JSON.parse(raw);
      if(!('periods' in data)) return alert('ไฟล์ไม่ถูกต้อง (ขาด periods)');
      restore(data);
    }catch(e){ alert('ข้อมูลไม่ถูกต้อง');}
  };
  if($('printBtn')) $('printBtn').onclick = function(){ window.print(); };

  // Simple apply
  if($('applySimple')) $('applySimple').onclick = function(){
    var N = toNum($('periods').value);
    if(!N){ alert('กรุณาระบุ "จำนวนงวดทั้งหมด" ก่อน'); return; }
    state.premium = toNum($('s-premium').value);
    var sInter = toNum($('s-interim').value);
    var sStart = Math.max(1, toNum($('s-interim-start').value||1));
    var sCount = Math.max(0, toNum($('s-interim-count').value));
    state.finalLump = toNum($('s-final').value);
    state.taxRate = toNum($('s-tax-rate').value)/100 || 0;

    state.interim = new Array(N).fill(0);
    for(var j=0;j<sCount;j++){
      var idx = sStart-1+j; if(idx<state.interim.length) state.interim[idx] = sInter;
    }
    refreshAll();
  };

  // Advanced inputs
  if($('premium')) $('premium').oninput = function(){ state.premium = toNum(this.value)||undefined; refreshAll(); };
  if($('feePerPeriod')) $('feePerPeriod').oninput = function(){ state.feePerPeriod = toNum(this.value)||undefined; refreshAll(); };
  if($('taxRate')) $('taxRate').oninput = function(){ state.taxRate = toNum(this.value)/100 || 0; refreshAll(); };
  if($('finalLump')) $('finalLump').oninput = function(){ state.finalLump = toNum(this.value)||undefined; refreshAll(); };

  // Table inline edit
  var tb = $('tbody');
  if(tb){
    tb.addEventListener('input', function(e){
      var t = e.target; if(!t.matches('input[data-row]')) return;
      var idx = +t.getAttribute('data-row'); state.interim[idx] = toNum(t.value); updateRowAndFooters(idx);
    });
  }

  // Tiers
  if($('addTier')) $('addTier').onclick = function(){ state.tiers.push({from:undefined,to:undefined,amt:undefined}); renderTiers(); };
  var tiersBox = $('tiers');
  if(tiersBox){
    tiersBox.addEventListener('input', function(e){
      var t = e.target; if(!t.matches('[data-tier]')) return;
      var i=+t.getAttribute('data-tier'), k=t.getAttribute('data-k');
      state.tiers[i][k] = (t.value===''?undefined:toNum(t.value));
    });
    tiersBox.addEventListener('click', function(e){
      var b=e.target; if(!b.matches('[data-tier-del]')) return;
      var i=+b.getAttribute('data-tier-del'); state.tiers.splice(i,1); renderTiers();
    });
  }
  if($('fillZero')) $('fillZero').onclick = function(){
    var N = state.periods|0; if(!N){ alert('กรุณาระบุ "จำนวนงวดทั้งหมด" ก่อน'); return; }
    state.interim = new Array(N).fill(0); refreshAll();
  };
  if($('clearInterim')) $('clearInterim').onclick = function(){ state.interim = []; refreshAll(); };
  if($('applyTiers')) $('applyTiers').onclick = function(){
    syncTiersFromDOM();
    var N = state.periods|0;
    if(!N){ alert('กรุณาระบุ "จำนวนงวดทั้งหมด" ก่อน'); return; }
    if(state.interim.length!==N) state.interim = new Array(N).fill(0);
    state.tiers.forEach(t=>{
      if(!t || !isFiniteNum(t.from) || !isFiniteNum(t.to) || !isFiniteNum(t.amt)) return;
      var s=Math.max(1, Math.min(N, t.from|0));
      var e=Math.max(1, Math.min(N, t.to|0));
      if(s>e) return;
      for(var i=s-1;i<=e-1;i++) state.interim[i] = Number(t.amt);
    });
    var tiers = $('tiers'); if(tiers){ tiers.classList.remove('flash'); void tiers.offsetWidth; tiers.classList.add('flash'); }
    renderTable(); refreshKPIs(); if(!$('view-charts').classList.contains('hidden')) renderCharts();
  };

  // a11y arrow keys
  document.querySelectorAll('[role="tablist"]').forEach(list=>{
    list.addEventListener('keydown', e=>{
      if(e.key!=='ArrowLeft' && e.key!=='ArrowRight') return;
      var tabs = list.querySelectorAll('[role="tab"]'); if(!tabs.length) return;
      var activeIdx = 0;
      tabs.forEach((t,i)=>{ if(t.classList.contains('active')) activeIdx=i; });
      var ni = (e.key==='ArrowRight') ? (activeIdx+1)%tabs.length : (activeIdx-1+tabs.length)%tabs.length;
      tabs[ni].focus(); tabs[ni].click();
    });
  });
}

/* ===== Init ===== */
(function init(){
  bind();
  refreshAll();
  var hash = (location.hash||'#simple').replace('#','');
  setView(allowedViews.indexOf(hash)===-1 ? 'simple' : hash);
})();
</script>
</body>
</html>
